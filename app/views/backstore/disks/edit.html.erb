
<% content_for :title, "Editar disco" %>


<h1 class="container">Editar disco</h1>
<br>

<div id="edit-disk-form" class="container">
  <article style="background-color: #f9efdb;">
    <%= form_with model: [:backstore, @disk] do |form| %>

      <% if @disk.errors.any? %>
        <div role="alert">
          <h6 style="text-decoration: underline; color: #b92621;">Errores:</h6>
          <ul>
            <% @disk.errors.each do |error| %>
              <li style="color: #b92621;">
                <p style="color: #b92621;"><%= error.full_message %></p>
              </li>
            <% end %>
          </ul>
        </div>
        <br>
      <% end %>

      <fieldset>
        <h4 class="container">Datos del Disco</h4>
        <p>
          <span style="color: #b92621;">• </span> Puede modificar aquí los datos de un disco ya registrado.</p>
        <p>
          <span style="color: #b92621;">• </span> En caso de hacer falta un género musical nuevo, por favor diríjase primero a <%= link_to "Crear género", new_backstore_genre_path, style: "color: #1343a0;" %>.

        </p>
        <br>
        <div class="grid">
          <div class="col-8">
            <div>
              <div class="grid" label="disk-basic-data">
                 <div class="col-6">
                    <div>
                        <%= form.label "Título" %>
                        <%= form.text_field :title, required: true, autocomplete: "off", value: @disk.title %>
                    </div>
                 </div>
                 <div class="col-6">
                    <div>
                        <%= form.label "Artista o banda" %>
                        <%= form.text_field :artist, required: true, autocomplete: "off", value: @disk.artist %>
                    </div>
                </div>
                <div class="col-6">
                  <div>
                    <%= form.label "Año de lanzamiento" %>
                    <%= form.number_field :year, required: true, in: 1870..Date.current.year, autocomplete: "off", value: @disk.year %>
                  </div>
                </div>
              </div>

              <div class="grid" label="disk-description">
                  <div>
                    <%= form.label "Descripción" %>
                    <%= form.text_area :description, required: true, autocomplete: "off", value: @disk.description %>
                  </div>
              </div>

              <div class="grid" label="disk-market-data">
                <div class="col-6">
                  <div>
                    <%= form.label "Precio unitario" %>
                    <%= form.number_field :price, required: true, step: "1", min: 0, autocomplete: "off", value: @disk.price %>
                  </div>
                </div>
                <div class="col-6">
                  <div>
                    <%= form.label "Cantidad disponible" %>
                    <%= form.number_field :stock, required: true, min: 0, autocomplete: "off", value: @disk.stock %>
                  </div>
                </div>
              </div>


              <div class="grid" label="disk-state-data">
                <div class="col-6">
                  <div class="field">
                    <%= form.label :state, "Estado del disco" %>
                    <div>
                      <%= form.radio_button :state, "Nuevo",
                            onclick: "toggleAudioField(false)" %>
                      <%= form.label :state_nuevo, "Nuevo" %>

                      <%= form.radio_button :state, "Usado",
                            onclick: "toggleAudioField(true)" %>
                      <%= form.label :state_usado, "Usado" %>
                    </div>
                  </div>

                </div>
                <div class="col-6">
                  <div class="field">
                    <%= form.label :format, "Formato del disco" %>
                    <div>
                      <%= form.radio_button :format, "CD" %>
                      <%= form.label :format_cd, "CD" %>

                      <%= form.radio_button :format, "Vinilo" %>
                      <%= form.label :format_vinilo, "Vinilo" %>
                    </div>
                  </div>
                </div>
              </div>

<br>
               <div id="audio-field" style="<%= @disk.state == 'Usado' ? '' : 'display: none;' %>">
                 <div class="field">
                   <%= form.label :audio_sample, "Audio de muestra (opcional)" %>
                   <p>
                     <span style="color: #b92621;">• </span> Audios de 30 segundos máximo.<br>
                     <span style="color: #b92621;">• </span> Formatos permitidos: MP3, OGG, FLAC
                   </p>

                   <% if @disk.audio_sample.attached? %>
                     <div style="
                       background-color: #f9efdb;
                       padding: 1rem;
                       border-radius: 8px;
                       margin-bottom: 1rem;
                     ">
                       <%= form.label :audio_sample, "Seleccionar nuevo audio" %>
                       <%= form.file_field :audio_sample,
                             accept: "audio/mpeg,audio/ogg,audio/flac" %>

                       <p>
                         <strong>Audio actual:</strong> <%= @disk.audio_sample.filename %>
                         (<%= number_to_human_size(@disk.audio_sample.byte_size) %>)
                       </p>

                       <audio controls style="width: 100%; margin: 0.5rem 0;">
                         <source src="<%= rails_blob_url(@disk.audio_sample) %>"
                                 type="<%= @disk.audio_sample.content_type %>">
                         Tu navegador no soporta el elemento de audio.
                       </audio>

                       <div style="margin-top: 0.5rem;">
                         <%= form.label :remove_audio_sample do %>
                           <%= form.check_box :remove_audio_sample %>
                           Eliminar audio actual
                         <% end %>
                       </div>
                     </div>
                   <% else %>
                   <%= form.file_field :audio_sample,
                         accept: "audio/mpeg,audio/ogg,audio/flac" %>
                   <% end %>


                 </div>
               </div>

              <%= form.label "Portada" %>
              <%= form.file_field :cover, value: @disk.cover %>

              <%= form.label "Imágenes" %>
              <%= form.file_field :images %>

              <%= form.label "Géneros" %>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1.0rem;">
                <%= form.collection_check_boxes :genre_ids, @genres.order(:genre_name), :id, :genre_name do |b| %>
                  <div style="display: flex; align-items: center;">
                    <%= b.check_box %>
                    <%= b.label style: "margin-left: 0.25rem; margin-bottom: 0; font-size: 17px" %>
                  </div>
                <% end %>
              </div>


            </div>
          </div>
        </div>
      </fieldset>

      <br>
      <div style="display: inline-block;">
        <%= form.submit "Guardar",
                style: "
                  background-color: #1343a0;
                  color: white;
                  font-family: monospace;
                  font-size: 18px;
                  min-width: auto;
                  width: auto;
                  display: inline-block;
                " %>
      </div>

      <div style="display: inline-block;"></div>
      <div style="display: inline-block;"></div>
      <div style="display: inline-block;"></div>
      <div style="display: inline-block;"></div>
      <div style="display: inline-block;"></div>

      <div style="display: inline-block;">
        <%= link_to "Cancelar", backstore_disks_path,
                class: "secondary",
                style: "
                  color: #b92621;
                  font-family: monospace;
                  font-size: 18px;
                  text-align: center;
                  padding: 0.5rem;
                  text-decoration: underline;
                " %>
      </div>

      <br>


      <script>
        function toggleAudioField(show) {
          const audioField = document.getElementById('audio-field');
          if (show) {
            audioField.style.display = 'block';
          } else {
            audioField.style.display = 'none';
            const audioInput = document.querySelector('#disk_audio_sample');
            if (audioInput) audioInput.value = '';
          }
        }
      </script>
    <% end %>
  </article>
</div>

<br>

<div>
  <p class="container">
    <%= link_to "<< Volver", backstore_disks_path, style: "color: #1343a0; font-family: monospace; font-size: 18px;" %>
  </p>
</div>
